function isNumeric(a){return!isNaN(parseFloat(a))&&isFinite(a)}function validate(a,b){if(4==b)return isNumeric(a);var c=VALIDATE_ARR[b];return c.test(a)}function User(){var a,b,c,d,e,f=[],g=["Исполнитель","Клиент","Администратор"];this.attrs=["name","id","login","password","email","type","requestsId"],this.name=function(){return this.constructor.name},this.id=function(b){return arguments.length?void(a=b):a},this.requestsId=function(a){return arguments.length?void(f=a):f},this.login=function(a){return arguments.length?void(validate(a,1)&&(b=a)):b},this.password=function(a){return arguments.length?void(validate(a,3)&&(c=a)):c},this.email=function(a){return arguments.length?void(validate(a,2)&&(d=a)):d},this.type=function(a){return arguments.length?void(-1!=g.indexOf(a)&&(e=a)):e},this.addRequestId=function(a){return arguments.length?(f.push(a),!0):!1},this.getRequestId=function(a){return a>=f.length?null:requestId[a]}}function Comment(){var a,b,c,d,e,f=["Вопрос","Комментарий","Created","Edited","Closed"];this.attrs=["name","id","userId","text","type","date"],this.name=function(){return this.constructor.name},this.id=function(b){return arguments.length?void(a=b):a},this.userId=function(a){return arguments.length?void(b=a):b},this.text=function(a){return arguments.length?void(validate(a,0)&&(c=a)):c},this.type=function(a){return arguments.length?void(-1!=f.indexOf(a)&&(d=a)):d},this.date=function(a){return arguments.length?void(e=a):e}}function Request(){var a,b,c,d,e,f,g,h,i,j,k=[],l=["LOW","MEDIUM","HIGH"];this.attrs=["name","id","customerId","performerId","description","summary","priority","estimated","deadline","commentsId","ready","created"],this.name=function(){return this.constructor.name},this.id=function(b){return arguments.length?void(a=b):a},this.customerId=function(a){return arguments.length?void(b=a):b},this.performerId=function(a){return arguments.length?void(c=a):c},this.commentsId=function(a){return arguments.length?void(k=a):k},this.addCommentId=function(a){return arguments.length?(k.push(a),!0):!1},this.getCommentId=function(a){return a>=k.length?null:k[a]},this.description=function(a){return arguments.length?void(validate(a,0)&&(d=a)):d},this.summary=function(a){return arguments.length?void(validate(a,0)&&(e=a)):e},this.priority=function(a){return arguments.length?void(-1!=l.indexOf(a)&&(f=a)):f},this.estimated=function(a){return arguments.length?void(isNumeric(a)&&a>=0&&(g=a)):g},this.created=function(a){return arguments.length?void(h=a):h},this.deadline=function(a){return arguments.length?void(i=a):i},this.ready=function(a){return arguments.length?void(isNumeric(a)&&a>=0&&100>=a&&(j=a)):j}}function hide(){authorisation.style.display="none",client_registration.style.display="none",create_comment.style.display="none",create_request.style.display="none",edit_request.style.display="none",list_request.style.display="none",performer_registration.style.display="none",select_performer.style.display="none",request_details.style.display="none",performer_creation.style.display="none"}function createSimpleElement(a,b){for(var c=2;c<arguments.length;c++){var d=document.createElement(b);d.innerHTML=arguments[c],a.appendChild(d)}}function displayError(a,b){var c=document.createElement("div");return c.className="error",c.innerHTML=a,document.body.appendChild(c),"undefined"===b||b===!1?c:(setTimeout(function(){document.body.removeChild(c)},2e3),c)}function removeElements(a,b,c){for(var d=a.querySelectorAll(b),e=c;e<d.length;e++)a.removeChild(d[e])}function injectSelect(a,b){for(var c=0;c<a.length;c++){var d,e;if(a[c].innerHTML="",b instanceof Array)for(var f=0;f<b.length;f++)d=document.createElement("option"),d.value=f,d.innerHTML=b[f],a[c].appendChild(d);else for(e in b)d=document.createElement("option"),d.value=e,d.innerHTML=b[e],a[c].appendChild(d)}}function makeNumbersObject(a,b){var c,d={};if(a>b){var e=a;a=b,b=e}for(c=a;b>=c;c++)d[c]=c;return d}function creation(a){a=a||window.event;var b=performer_creation.querySelector('input[name="login"]').value;if(!validate(b,1)||b in localStorage)displayError("Ошибка!");else{var c=new User;c.id(b),c.login(b),c.type("Исполнитель"),saveObject(c),hide(),list_request.style.display="block"}a.preventDefault?a.preventDefault():a.returnValue=!1}function registration(a){a=a||window.event;var b=performer_registration.querySelector('input[name="login"]').value;if(!validate(b,1)||b in localStorage)displayError("Ошибка!");else{var c=new User;c.id(b),c.login(b),c.type("Исполнитель"),saveObject(c),hide(),authorisation.style.display="block"}a.preventDefault?a.preventDefault():a.returnValue=!1}function registration1(a){a=a||window.event;var b=client_registration.querySelector('input[name="login"]').value;if(!validate(b,1)||b in localStorage)displayError("Ошибка!");else{var c=new User;c.id(b),c.login(b),c.type("Клиент"),saveObject(c),hide(),authorisation.style.display="block"}a.preventDefault?a.preventDefault():a.returnValue=!1}function showRequests(a){a=a||window.event,hide(),list_request.style.display="block","Администратор"!==user.type()?document.getElementById("create-performer").style.display="none":document.getElementById("create-performer").style.display="block";for(var b=user.login(),c=document.getElementsByClassName("user"),d=0;d<c.length;d++)c[d].innerHTML=b;"Исполнитель"==user.type()?document.getElementById("create-request").style.display="none":document.getElementById("create-request").style.display="block";var e,f=user.requestsId(),g=list_request.querySelector("table");if(removeElements(g,"tr",1),0===f.length){e=document.createElement("tr");var h=document.createElement("td");return h.setAttribute("colspan","7"),h.innerHTML="Нет заявок",e.appendChild(h),g.appendChild(e),!1}for(var i=0;i<f.length;i++){var j=f[i],k=getObject(j);e=document.createElement("tr"),createSimpleElement(e,"td",k.id(),k.customerId(),k.performerId(),k.summary(),k.priority(),k.estimated(),k.deadline().toLocaleString("ru",options),k.ready()+"%"),e.firstElementChild.style.display="none",g.appendChild(e)}var l=g.querySelectorAll("tr");if(1!==l[1].children.length)for(var m=1;m<l.length;m++)l[m].temp=l[m].firstElementChild.innerHTML,l[m].addEventListener("click",selectRequest);a.preventDefault?a.preventDefault():a.returnValue=!1}function showRequestDetails(a){hide(),request_details.style.display="block",request=getObject(a);for(var b=user.login(),c=document.getElementsByClassName("user"),d=0;d<c.length;d++)c[d].innerHTML=b;c=document.getElementById("request"),c.innerHTML=request.id(),"Клиент"===user.type()?document.getElementById("edit-request").style.display="none":document.getElementById("edit-request").style.display="block";var e=request_details.querySelector("table");removeElements(e,"tr",1),tr=document.createElement("tr"),createSimpleElement(tr,"td",request.customerId(),request.performerId(),request.summary(),request.priority(),request.estimated(),request.created(),request.deadline(),request.ready()+"%"),e.appendChild(tr);var f=document.getElementById("description");f.innerHTML=request.description();var g=request.commentsId(),h=document.getElementById("comments");if(0===g.length)h.innerHTML="<h3>Комментариев еще нет.</h3>";else{h.innerHTML="<h3>Комментарии:</h3>";for(var i=0;i<g.length;i++){var j=getObject(g[i]),k=document.createElement("ul"),l=document.createElement("li");l.innerHTML=j.date()+" - "+j.type()+" ["+j.userId()+"]";var m=document.createElement("li");k.appendChild(l),m=document.createElement("li"),m.innerHTML=j.text(),k.appendChild(m),h.appendChild(k)}}}function auth(a){a=a||window.event;var b=authorisation.querySelector('input[name="login"]');return validate(b.value,1)&&(user=getObject(b.value),null!==user)?(showRequests(),!1):(displayError("Ошибка!"),void(a.preventDefault?a.preventDefault():a.returnValue=!1))}function selectRequest(a){a=a||window.event;a.target||a.srcElement;"TR"===a.currentTarget.tagName&&(id=a.currentTarget.temp,a.stopPropagation(),showRequestDetails(id)),a.preventDefault?a.preventDefault():a.returnValue=!1}function createRequest(a){a=a||window.event,hide(),create_request.style.display="block";var b=create_request.querySelector('select[name="performer"]'),c=[];for(var d in localStorage)try{var e=getObject(d);void 0!==e.login()&&"Исполнитель"==e.type()&&c.push(d)}catch(f){}removeElements(b,"option",0);for(var g=0;g<c.length;g++){var h=document.createElement("option");h.innerHTML=c[g],b.appendChild(h)}a.preventDefault?a.preventDefault():a.returnValue=!1}function recordRequest(a){a=a||window.event;var b=(new Date).toLocaleString("ru",options),c=create_request.querySelector('select[name="performer"]').value,d=create_request.querySelector('input[name="summary"]').value,e=create_request.querySelector("textarea").value,f=create_request.querySelector('select[name="priority"]').value,g=create_request.querySelector('input[name="estimated"]').value;if(!validate(g,4)||0===d.length||0===e.length)return displayError("Ошибка!"),!1;var h=new Date(create_request.querySelector(".years").value,create_request.querySelector(".months").value,create_request.querySelector(".days").value,create_request.querySelector('input[name="hours"]').value,create_request.querySelector('input[name="minutes"]').value,create_request.querySelector('input[name="seconds"]').value).toLocaleString("ru",options),i=new Request;i.created(b),i.performerId(c),i.customerId(user.id()),i.summary(d),i.description(e),i.priority(f),i.estimated(g),i.deadline(h),i.ready(0),i.id(Math.uuid(20)),saveObject(i),user=getObject(user.id()),user.addRequestId(i.id()),saveObject(user);var j=getObject(c);j.addRequestId(i.id()),saveObject(j);var k=getObject("admin");k.addRequestId(i.id()),saveObject(k),showRequests(user),a.preventDefault?a.preventDefault():a.returnValue=!1}function createComment(a){a=a||window.event;var b=create_comment.querySelector('[name="text"]').value,c=create_comment.querySelector('[name="type"]').value,d=(new Date).toLocaleString("ru",options);return validate(b,0)?(comment=new Comment,comment.id(Math.uuid(20)),comment.type(c),comment.date(d),comment.userId(user.id()),comment.text(b),saveObject(comment),request=getObject(request.id()),request.addCommentId(comment.id()),saveObject(request),showRequestDetails(request.id()),void(a.preventDefault?a.preventDefault():a.returnValue=!1)):(displayError("Ошибка!"),!1)}function editRequest(a){a=a||window.event,hide(),edit_request.style.display="block";var b=document.getElementById("administrator-edit");if("Администратор"==user.type()){b.style.display="block";var c=edit_request.querySelector('[name="performer"]');removeElements(c,"option",0);var d=[];for(var e in localStorage)try{var f=getObject(e);void 0!==f.login()&&"Исполнитель"==f.type()&&d.push(e)}catch(g){}for(var h=0;h<d.length;h++){var i=document.createElement("option");i.innerHTML=d[h],c.appendChild(i)}}else b.style.display="none";a.preventDefault?a.preventDefault():a.returnValue=!1}function submitRequest(a){if(a=a||window.event,request=getObject(request.id()),"Администратор"===user.type()){var b=edit_request.querySelector('select[name="performer"]').value,c=edit_request.querySelector('input[name="estimated"]').value;if(!validate(c,4))return displayError("Ошибка!"),!1;var d=new Date(edit_request.querySelector(".years").value,edit_request.querySelector(".months").value,edit_request.querySelector(".days").value,edit_request.querySelector('input[name="hours"]').value,edit_request.querySelector('input[name="minutes"]').value,edit_request.querySelector('input[name="seconds"]').value).toLocaleString("ru",options);request.performerId(b),request.estimated(c),request.deadline(d)}var e=edit_request.querySelector('input[name="ready"]').value;return!validate(e,4)||0>e||e>100?(displayError("Ошибка!"),!1):(request.ready(e),saveObject(request),showRequestDetails(request.id()),void(a.preventDefault?a.preventDefault():a.returnValue=!1))}var VALIDATE_ARR=[/^[а-яА-ЯёЁa-zA-Z0-9\s.?"',:;%@!()]+$/,/^[a-zA-Z][a-zA-Z0-9-_\.]{2,20}$/,/^([a-zA-Z0-9_-]+\.)*[a-zA-Z0-9_-]+@[a-z0-9_-]+(\.[a-z0-9_-]+)*\.[a-z]{2,6}$/,/^[a-zA-Z][a-zA-Z0-9-_\.]{6,20}$/,/^[1-9][0-9]+$/];if(Math.uuid=function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");return function(b,c){var d=a,e=[],f=Math.random;if(c=c||d.length,b)for(var g=0;b>g;g++)e[g]=d[0|f()*c];else{var h;e[8]=e[13]=e[18]=e[23]="-",e[14]="4";for(var i=0;36>i;i++)e[i]||(h=0|16*f(),e[i]=d[19==i?3&h|8:15&h])}return e.join("")}}(),"undefined"==typeof Storage)throw"Ошибка! У вас устаревший браузер!";var getAttributes=function(a){if("object"!=typeof a)return null;for(var b={},c=0;c<a.attrs.length;c++){var d=a.attrs[c];b[d]=a[d]()}return b},saveObject=function(a){if("object"!=typeof a)return null;var b=JSON.stringify(getAttributes(a));localStorage[a.id()]=b},getObject=function(a){if(a in localStorage){var b=JSON.parse(localStorage[a]);return init(b)}return null},init=function(object){if("object"!=typeof object)return null;var result=eval("new "+object.name+"();");delete object.name;for(var i in object)result[i](object[i]);return result},authorisation,client_registration,create_comment,create_request,edit_request,list_request,performer_registration,select_performer,request_details,performer_creation,user=null,request=null,comment=null,options={year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"},ready=function(){injectSelect(document.getElementsByClassName("months"),["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]),injectSelect(document.getElementsByClassName("years"),makeNumbersObject(2e3,2016)),injectSelect(document.getElementsByClassName("days"),makeNumbersObject(1,31)),authorisation=document.getElementById("authorisation"),client_registration=document.getElementById("client_registration"),create_comment=document.getElementById("create_comment"),create_request=document.getElementById("create_request"),edit_request=document.getElementById("edit_request"),list_request=document.getElementById("list_request"),performer_registration=document.getElementById("performer_registration"),select_performer=document.getElementById("select_performer"),request_details=document.getElementById("request_details"),performer_creation=document.getElementById("performer_creation"),hide(),authorisation.style.display="block";var a=getObject("admin");null===a&&(a=new User,a.id("admin"),a.login("admin"),a.type("Администратор"),saveObject(a)),authorisation.getElementsByTagName("form")[0].addEventListener("submit",auth),document.getElementById("reg-performer").addEventListener("click",function(){hide(),performer_registration.style.display="block",document.querySelector('#performer_registration input[type="submit"]').addEventListener("click",registration)}),document.getElementById("reg-customer").addEventListener("click",function(){hide(),client_registration.style.display="block",document.querySelector('#client_registration input[type="submit"]').addEventListener("click",registration1)}),document.getElementById("create-request").addEventListener("click",createRequest),create_request.querySelector('input[type="submit"]').addEventListener("click",recordRequest),document.getElementById("list-requests").addEventListener("click",showRequests),document.getElementById("add-comment").addEventListener("click",function(){hide(),create_comment.style.display="block";var a,b=document.getElementsByClassName("not-performer");a="Исполнитель"===user.type()?"none":"auto";for(var c=0;c<b.length;++c)b[c].style.display=a;create_comment.querySelector("form").addEventListener("submit",createComment)}),document.getElementById("edit-request").addEventListener("click",editRequest),edit_request.querySelector("form").addEventListener("submit",submitRequest),document.getElementById("back-authorisation").addEventListener("click",function(){return hide(),authorisation.style.display="block",!1}),document.getElementById("create-performer").addEventListener("click",function(){return hide(),performer_creation.style.display="block",performer_creation.querySelector("form").addEventListener("submit",creation),!1})};document.addEventListener("DOMContentLoaded",ready);